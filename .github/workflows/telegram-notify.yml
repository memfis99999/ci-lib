name: Telegram Notifier

on:
  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥—Ä—É–≥–∏—Ö workflow
  workflow_call:
    inputs:
      message:
        required: false
        type: string
        default: ""
    secrets:
      TELEGRAM_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true
      TELEGRAM_TOPIC_ID:
        required: false

  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub (–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫)
  workflow_dispatch:
    inputs:
      message:
        description: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)'
        required: false
        type: string
        default: '–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! üõ†Ô∏è'

jobs:
  send-message:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse config (Unified Logic)
        id: check_status
        run: |
          FILE=".github/telegram-enabled.txt"
          ENABLED="false"

          if [ -f "$FILE" ]; then
            # –ü–∞—Ä—Å–∏–Ω–≥ –ø–µ—Ä–≤–æ–π –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø—Ä–æ–±–µ–ª–æ–≤
            RAW_VALUE=$(grep -v '^#' "$FILE" | grep -v '^[[:space:]]*$' | head -n 1 | xargs)
            VALUE=$(echo "$RAW_VALUE" | tr '[:upper:]' '[:lower:]')
            
            if [[ "$VALUE" == "1" || "$VALUE" == "true" || "$VALUE" == "on" ]]; then
              ENABLED="true"
            fi
          fi

          echo "is_enabled=$ENABLED" >> $GITHUB_OUTPUT

      - name: Send Telegram Message
        if: steps.check_status.outputs.is_enabled == 'true'
        run: |
          # –í—ã–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ: –ª–∏–±–æ –∏–∑ –≤—ã–∑–æ–≤–∞, –ª–∏–±–æ –∏–∑ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞, –ª–∏–±–æ —Ö–∞—Ä–¥–∫–æ–¥
          INPUT_MSG="${{ inputs.message }}"
          DISPATCH_MSG="${{ github.event.inputs.message }}"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤—ã–∑–æ–≤ > —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ > –¥–µ—Ñ–æ–ª—Ç)
          FINAL_MSG="${INPUT_MSG:-$DISPATCH_MSG}"
          if [ -z "$FINAL_MSG" ]; then
             FINAL_MSG="–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ (–ø—É—Å—Ç–æ–π –≤–≤–æ–¥) ‚ö†Ô∏è"
          fi

          # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ jq
          JSON_MSG=$(echo "$FINAL_MSG" | jq -aRs .)
          
          TOPIC_ID="${{ secrets.TELEGRAM_TOPIC_ID }}"
          URL="https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"
          
          if [ -z "$TOPIC_ID" ]; then
            curl -s -X POST "$URL" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": $JSON_MSG, \"parse_mode\": \"HTML\"}"
          else
            curl -s -X POST "$URL" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"message_thread_id\": \"$TOPIC_ID\", \"text\": $JSON_MSG, \"parse_mode\": \"HTML\"}"
          fi
