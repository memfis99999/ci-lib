- name: Sync Mirror
  id: sync
  run: |
    OUTPUT=$(bash .ci-lib-temp/scripts/sync-mirror.sh)
    echo "$OUTPUT" >> $GITHUB_OUTPUT

- name: Merge Target
  id: merge
  if: steps.sync.outputs.changed == 'true'
  run: |
    # Передаем флаг критических изменений третьим параметром
    OUTPUT=$(bash .ci-lib-temp/scripts/merge-target.sh "" "" "${{ steps.sync.outputs.critical }}")
    echo "$OUTPUT" >> $GITHUB_OUTPUT

- name: Format & Notify
  if: always() && (steps.sync.outputs.changed == 'true' || failure())
  run: |
    STATUS="${{ job.status == 'success' && (steps.merge.outputs.merge_result || 'MIRROR_ONLY') || '❌ ERROR' }}"
    # Передаем список файлов шестым параметром
    MSG=$(bash .ci-lib-temp/scripts/gen-message.sh "${{ github.repository }}" "" "$STATUS" "${{ steps.sync.outputs.hash }}" "${{ github.run_id }}" "${{ steps.sync.outputs.critical_list }}")
    bash .ci-lib-temp/scripts/tg-notify.sh "$MSG" "${{ secrets.TELEGRAM_TOKEN }}" "${{ secrets.TELEGRAM_CHAT_ID }}" "${{ secrets.TELEGRAM_TOPIC_ID }}" "${{ inputs.force_notify }}"
