name: Universal Git Sync (Config-Driven)

on:
  workflow_call:
    inputs:
      force_notify: { required: false, type: boolean, default: false }
    secrets:
      TELEGRAM_TOKEN: { required: true }
      TELEGRAM_CHAT_ID: { required: true }
      TELEGRAM_TOPIC_ID: { required: false }
      
jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Target Repo
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Checkout CI Library
        uses: actions/checkout@v4
        with: { repository: memfis99999/ci-lib, path: .ci-lib-temp }

      - name: Git Config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync Mirror
        id: sync
        run: |
          # Вызов без аргументов — всё возьмет из .github/sync/
          OUTPUT=$(bash .ci-lib-temp/scripts/sync-mirror.sh)
          echo "$OUTPUT" >> $GITHUB_OUTPUT

      - name: Merge Target
        id: merge
        if: steps.sync.outputs.changed == 'true'
        run: |
          # Вызов без аргументов
          OUTPUT=$(bash .ci-lib-temp/scripts/merge-target.sh)
          echo "$OUTPUT" >> $GITHUB_OUTPUT

      - name: Prepare & Send Notify
        if: always() && (steps.sync.outputs.changed == 'true' || failure())
        run: |
          STATUS="${{ job.status == 'success' && (steps.merge.outputs.merge_result || 'MIRROR_ONLY') || '❌ ERROR' }}"
          # Формируем сообщение (скрипт сам найдет Repo и Branch)
          MSG=$(bash .ci-lib-temp/scripts/gen-message.sh "${{ github.repository }}" "" "$STATUS" "${{ steps.sync.outputs.hash }}" "${{ github.run_id }}")
          # Отправляем
          bash .ci-lib-temp/scripts/tg-notify.sh "$MSG" "${{ secrets.TELEGRAM_TOKEN }}" "${{ secrets.TELEGRAM_CHAT_ID }}" "${{ secrets.TELEGRAM_TOPIC_ID }}" "${{ inputs.force_notify }}"
